{% extends 'base.html' %}
{% load static %}

{% block title %}Notificaciones - InmueblesApp{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-bell"></i> Notificaciones</h2>
        <div>
            {% if notificaciones.exists %}
            <a href="{% url 'notificaciones:marcar_todas_leidas' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-check-double"></i> Marcar todas como leídas
            </a>
            {% endif %}
            <a href="{% url 'notificaciones:configuracion' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-cog"></i> Configuración
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if not estado or estado == 'todas' %}active{% endif %}" 
               href="?estado=todas{% if tipo %}&tipo={{ tipo }}{% endif %}">
                Todas {% if total_notificaciones %}({{ total_notificaciones }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if estado == 'no_leidas' %}active{% endif %}" 
               href="?estado=no_leidas{% if tipo %}&tipo={{ tipo }}{% endif %}">
                No leídas {% if total_no_leidas %}({{ total_no_leidas }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if estado == 'leidas' %}active{% endif %}" 
               href="?estado=leidas{% if tipo %}&tipo={{ tipo }}{% endif %}">
                Leídas
            </a>
        </li>
    </ul>

    <!-- Filtros por tipo -->
    <div class="btn-group mb-4" role="group">
        <a href="?{% if estado %}estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if not tipo %}active{% endif %}">
            <i class="fas fa-list"></i> Todas
        </a>
        <a href="?tipo=sistema{% if estado %}&estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if tipo == 'sistema' %}active{% endif %}">
            <i class="fas fa-cog"></i> Sistema
        </a>
        <a href="?tipo=inmueble{% if estado %}&estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if tipo == 'inmueble' %}active{% endif %}">
            <i class="fas fa-building"></i> Inmuebles
        </a>
        <a href="?tipo=contrato{% if estado %}&estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if tipo == 'contrato' %}active{% endif %}">
            <i class="fas fa-file-contract"></i> Contratos
        </a>
        <a href="?tipo=pago{% if estado %}&estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if tipo == 'pago' %}active{% endif %}">
            <i class="fas fa-dollar-sign"></i> Pagos
        </a>
        <a href="?tipo=mantenimiento{% if estado %}&estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if tipo == 'mantenimiento' %}active{% endif %}">
            <i class="fas fa-tools"></i> Mantenimiento
        </a>
        <a href="?tipo=mensaje{% if estado %}&estado={{ estado }}{% endif %}" 
           class="btn btn-sm btn-outline-secondary {% if tipo == 'mensaje' %}active{% endif %}">
            <i class="fas fa-envelope"></i> Mensajes
        </a>
    </div>

    <!-- Lista de notificaciones -->
    {% if notificaciones %}
    <div class="list-group">
        {% for notificacion in notificaciones %}
        <div class="list-group-item {% if not notificacion.leida %}list-group-item-primary{% endif %}">
            <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <!-- Icono según tipo -->
                        {% if notificacion.tipo == 'sistema' %}
                        <i class="fas fa-cog text-secondary fa-2x me-3"></i>
                        {% elif notificacion.tipo == 'inmueble' %}
                        <i class="fas fa-building text-primary fa-2x me-3"></i>
                        {% elif notificacion.tipo == 'contrato' %}
                        <i class="fas fa-file-contract text-success fa-2x me-3"></i>
                        {% elif notificacion.tipo == 'pago' %}
                        <i class="fas fa-dollar-sign text-warning fa-2x me-3"></i>
                        {% elif notificacion.tipo == 'mantenimiento' %}
                        <i class="fas fa-tools text-danger fa-2x me-3"></i>
                        {% elif notificacion.tipo == 'mensaje' %}
                        <i class="fas fa-envelope text-info fa-2x me-3"></i>
                        {% else %}
                        <i class="fas fa-bell text-muted fa-2x me-3"></i>
                        {% endif %}

                        <div>
                            <h5 class="mb-1">
                                {{ notificacion.titulo }}
                                {% if not notificacion.leida %}
                                <span class="badge bg-primary">Nueva</span>
                                {% endif %}
                                
                                <!-- Badge de prioridad -->
                                {% if notificacion.prioridad == 'alta' %}
                                <span class="badge bg-danger">Alta</span>
                                {% elif notificacion.prioridad == 'normal' %}
                                <span class="badge bg-info">Normal</span>
                                {% endif %}
                            </h5>
                            <p class="mb-1">{{ notificacion.mensaje }}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> 
                                {{ notificacion.fecha_creacion|timesince }} atrás
                            </small>
                        </div>
                    </div>

                    <!-- Enlace si existe -->
                    {% if notificacion.enlace %}
                    <div class="mt-2">
                        <a href="{{ notificacion.enlace }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-arrow-right"></i> Ver detalles
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Acciones -->
                <div class="ms-3 text-end" style="min-width: 120px;">
                    {% if not notificacion.leida %}
                    <a href="{% url 'notificaciones:marcar_leida' notificacion.id %}?next={{ request.path }}" 
                       class="btn btn-sm btn-success mb-1 w-100" 
                       title="Marcar como leída">
                        <i class="fas fa-check"></i> Leída
                    </a>
                    {% endif %}
                    <a href="{% url 'notificaciones:eliminar' notificacion.id %}?next={{ request.path }}" 
                       class="btn btn-sm btn-danger w-100" 
                       onclick="return confirm('¿Eliminar esta notificación?')"
                       title="Eliminar">
                        <i class="fas fa-trash"></i> Eliminar
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Paginación -->
    {% if notificaciones.has_other_pages %}
    <nav aria-label="Paginación" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if notificaciones.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ notificaciones.previous_page_number }}{% if estado %}&estado={{ estado }}{% endif %}{% if tipo %}&tipo={{ tipo }}{% endif %}">
                    Anterior
                </a>
            </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">
                    Página {{ notificaciones.number }} de {{ notificaciones.paginator.num_pages }}
                </span>
            </li>
            
            {% if notificaciones.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ notificaciones.next_page_number }}{% if estado %}&estado={{ estado }}{% endif %}{% if tipo %}&tipo={{ tipo }}{% endif %}">
                    Siguiente
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Sin notificaciones -->
    <div class="text-center py-5">
        <i class="fas fa-bell-slash fa-5x text-muted mb-3"></i>
        <h3>No tienes notificaciones</h3>
        <p class="text-muted">
            {% if estado == 'no_leidas' %}
            ¡Genial! No tienes notificaciones pendientes por leer
            {% elif estado == 'leidas' %}
            No hay notificaciones leídas
            {% else %}
            Cuando recibas notificaciones, aparecerán aquí
            {% endif %}
        </p>
        <a href="{% url 'core:dashboard' %}" class="btn btn-primary">
            <i class="fas fa-home"></i> Volver al Dashboard
        </a>
    </div>
    {% endif %}
</div>

<style>
.list-group-item {
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
}

.list-group-item:not(.list-group-item-primary):hover {
    background-color: #f8f9fa;
    border-left-color: #dee2e6;
}

.list-group-item-primary {
    background-color: #e7f3ff;
    border-left-color: #0d6efd;
}

.list-group-item-primary:hover {
    background-color: #d4e9ff;
}

.btn-group .btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}
</style>
{% endblock %}
